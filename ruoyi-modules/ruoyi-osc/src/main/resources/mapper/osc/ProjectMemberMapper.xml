<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.dromara.osc.mapper.ProjectMemberMapper">

    <resultMap type="org.dromara.osc.domain.vo.ProjectMemberVo" id="ProjectMemberResult">
        <result property="id" column="id"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="projectCode" column="project_code"/>
        <result property="memberId" column="user_id"/>
        <result property="memberName" column="member_name"/>
        <result property="memberEmail" column="member_email"/>
        <result property="role" column="role"/>
        <result property="roleName" column="role_name"/>
        <result property="permissionLevel" column="permission_level"/>
        <result property="isActive" column="is_active"/>
        <result property="contributionScore" column="contribution_score"/>
        <result property="joinTime" column="join_time"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectProjectMemberVo">
        select pm.id, pm.project_id, pm.user_id, pm.role, pm.permission_level, pm.is_active, 
               pm.contribution_score, pm.join_time, pm.remark, pm.create_time, pm.update_time,
               p.project_name, p.project_code,
               u.nick_name as member_name, u.email as member_email,
               case pm.role 
                   when '0' then '普通成员'
                   when '1' then '项目负责人'
                   when '2' then '核心开发者'
                   when '3' then '维护者'
                   when '4' then '贡献者'
                   else '未知'
               end as role_name
        from os_project_member pm
        left join os_project p on pm.project_id = p.project_id
        left join sys_user u on pm.user_id = u.user_id
    </sql>

    <select id="queryList" parameterType="org.dromara.osc.domain.bo.ProjectMemberBo" resultMap="ProjectMemberResult">
        <include refid="selectProjectMemberVo"/>
        <where>
            <if test="bo.projectId != null">
                AND pm.project_id = #{bo.projectId}
            </if>
            <if test="bo.memberId != null">
                AND pm.user_id = #{bo.memberId}
            </if>
            <if test="bo.role != null and bo.role != ''">
                AND pm.role = #{bo.role}
            </if>
            <if test="bo.isActive != null and bo.isActive != ''">
                AND pm.is_active = #{bo.isActive}
            </if>
            <if test="bo.projectName != null and bo.projectName != ''">
                AND p.project_name like concat('%', #{bo.projectName}, '%')
            </if>
            <if test="bo.memberName != null and bo.memberName != ''">
                AND u.nick_name like concat('%', #{bo.memberName}, '%')
            </if>
            <if test="bo.beginJoinTime != null">
                AND pm.join_time >= #{bo.beginJoinTime}
            </if>
            <if test="bo.endJoinTime != null">
                AND pm.join_time &lt;= #{bo.endJoinTime}
            </if>
        </where>
        order by pm.create_time desc
    </select>

    <select id="queryPageList" parameterType="org.dromara.osc.domain.bo.ProjectMemberBo" resultMap="ProjectMemberResult">
        <include refid="selectProjectMemberVo"/>
        <where>
            <if test="bo.projectId != null">
                AND pm.project_id = #{bo.projectId}
            </if>
            <if test="bo.memberId != null">
                AND pm.user_id = #{bo.memberId}
            </if>
            <if test="bo.role != null and bo.role != ''">
                AND pm.role = #{bo.role}
            </if>
            <if test="bo.isActive != null and bo.isActive != ''">
                AND pm.is_active = #{bo.isActive}
            </if>
            <if test="bo.projectName != null and bo.projectName != ''">
                AND p.project_name like concat('%', #{bo.projectName}, '%')
            </if>
            <if test="bo.memberName != null and bo.memberName != ''">
                AND u.nick_name like concat('%', #{bo.memberName}, '%')
            </if>
            <if test="bo.beginJoinTime != null">
                AND pm.join_time >= #{bo.beginJoinTime}
            </if>
            <if test="bo.endJoinTime != null">
                AND pm.join_time &lt;= #{bo.endJoinTime}
            </if>
        </where>
        order by pm.create_time desc
    </select>

    <select id="queryById" parameterType="Long" resultMap="ProjectMemberResult">
        <include refid="selectProjectMemberVo"/>
        where pm.id = #{id}
    </select>

    <select id="queryByProjectId" parameterType="Long" resultMap="ProjectMemberResult">
        <include refid="selectProjectMemberVo"/>
        where pm.project_id = #{projectId}
        order by pm.create_time desc
    </select>

    <select id="queryByMemberId" parameterType="Long" resultMap="ProjectMemberResult">
        <include refid="selectProjectMemberVo"/>
        where pm.user_id = #{memberId}
        order by pm.create_time desc
    </select>

</mapper>
